<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>D3 Pie Chart with Conditional Labels</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 1rem;
    }

    svg {
      margin-top: 1rem;
    }

    button {
      margin: 0 0.5rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      cursor: pointer;
    }

    text.label {
      fill: white;
      font-weight: bold;
      font-size: 8px;
      pointer-events: none;
    }
  </style>
</head>

<body>
  <h1>D3 Pie Chart Example</h1>
  <div id="chart"></div>
  <button id="firstBtn">Show first</button>
  <button id="secondBtn">Show second</button>
  <script>
    const width = 500;



    const data = d3.tsvParse(`first\tsecond
    35\t40
    25\t25
    20\t22
    10\t8
    5\t2
    5\t2`, d3.autoType);

    function getFirstPercent(d, data) {
      const percent = (d.data.first / d3.sum(data, d => d.first)) * 100;
      return percent.toFixed(1) + "%";
    }

    // Load numbers.json and use it for the chart
    async function getJsonData() {
      const response = await fetch('numbers.json');
      const json = await response.json();
      // Convert the JSON structure to an array of objects for D3
      // Example: [{label: '0', value: 35}, ...]
      const firstValueArr = Object.entries(json.firstValue).map(([label, value]) => ({
        label: Number(label),
        value: value
      }));
      const secondValueArr = Object.entries(json.secondValue).map(([label, value]) => ({
        label: Number(label),
        value: value
      }));
      return { firstValueArr, secondValueArr };
    }

    // Example usage:
    getJsonData().then(({ firstValueArr, secondValueArr }) => {
      console.log('firstValueArr', firstValueArr);
      console.log('secondValueArr', secondValueArr);
      // You can use firstValueArr or secondValueArr for your chart
    });

    function createChart(data, width) {
      const height = Math.min(500, width / 2);
      const outerRadius = height / 2 - 10;
      const color = d3.scaleOrdinal(d3.schemeObservable10);

      const svg = d3.create("svg")
        .attr("viewBox", [-width / 2, -height / 2, width, height]);

      const arc = d3.arc()
        .innerRadius(0)
        .outerRadius(outerRadius);

      const pie = d3.pie().sort(null).value(d => d["first"]);

      let arcs = pie(data);

      const path = svg.datum(data).selectAll("path")
        .data(arcs)
        .join("path")
        .attr("fill", (d, i) => color(i))
        .attr("d", arc)
        .each(function (d) { this._current = d; });

      // Add a group for labels inside slices
      const labelGroup = svg.append("g")
        .attr("class", "labels");

      // Create label elements, initially for first dataset
      let labels = labelGroup.selectAll("text")
        .data(arcs)
        .join("text")
        .attr("class", "label")
        .attr("dy", "0.35em")
        .attr("text-anchor", "middle")
        .attr("transform", d => `translate(${arc.centroid(d)})`)
        .text(d => getFirstPercent(d, data));

      function change(value) {
        pie.value(d => d[value]);
        arcs = pie(data);

        path.data(arcs);
        path.transition().duration(750).attrTween("d", arcTween);

        labels = labelGroup.selectAll("text")
          .data(arcs);

        if (value === "first") {
          // Enter + update
          labels.join(
            enter => enter.append("text")
              .attr("class", "label")
              .attr("dy", "0.35em")
              .attr("text-anchor", "middle")
              .attr("transform", d => `translate(${arc.centroid(d)})`)
              .style("opacity", 0)
              .text(d => getFirstPercent(d, data))
              .call(enter => enter.transition().duration(750).style("opacity", 1)),
            update => update,
            exit => exit.remove()
          );
        } else {
          // Hide labels on second
          labels.transition().duration(750).style("opacity", 0).remove();
        }
      }

      function arcTween(a) {
        const i = d3.interpolate(this._current, a);
        this._current = i(0);
        return t => arc(i(t));
      }

      return Object.assign(svg.node(), { change });
    }

    const chart = createChart(data, width);
    document.getElementById("chart").appendChild(chart);

    document.getElementById("firstBtn").addEventListener("click", () => chart.change("first"));
    document.getElementById("secondBtn").addEventListener("click", () => chart.change("second"));
  </script>
</body>

</html>